<!doctype html>
<html>
<head>
<title>ETHLottery</title>
<meta charset="utf-8">
<script type="text/javascript" src="node_modules/bignumber.js/bignumber.min.js"></script>
<script type="text/javascript" src="node_modules/web3/dist/web3-light.js"></script>
<style>
div {
    font-weight: bold;
}

div span {
    font-weight: normal;
}
#error {
    color: #f00;
}
</style>
</head>

<body>
    <h1>ETHLottery</h1>

    <h1>Lottery Info</h1>
    <div>ADDRESS: <span id="address"></span></div> 
    <div>OPEN: <span id="open"></span></div> 
    <div>TOTAL ACCUMULATED: <span id="total"></span> <span>ETH</span></div> 
    <div>OWNER FEE: <span id="owner-fee"></span> <span>%</span></div> 
    <div>FEE: <span id="fee"></span> <span>ETH</span></div> 
    <div>RESULT: <span id="result"></span></div> 

    <h1>Play</h1>
    <div id="error"></div>
    <div>PLAY FROM: <select id="participant"></select> <input type="password" id="pass" placeholder="password"></div>
    <div>GAS: <input id="gas" size="10" value="90000"></div>
    <div>GUESS LAST BLOCK HASH CHAR: <input size="2" id="play" maxlength="1"> <input type="button" value="go lucky char, do your magic" onClick="play();"></div>
    <div>WITHDRAW: <input type="button" value="go get my ETHs now!" onClick="withdraw();"></div>



<script type="text/javascript">

    var Web3 = require('web3');
    var BigNumber = require('bignumber.js');
    
    if (typeof web3 !== 'undefined') {
          var web3 = new Web3(web3.currentProvider);
    } else {
        // set the provider you want from Web3.providers, for local dev
          var web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
    }

    var abi = [{"constant":true,"inputs":[],"name":"owner_fee","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"destruct","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"total","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"withdraw","outputs":[],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_char","type":"bytes1"}],"name":"lottery","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"result","outputs":[{"name":"","type":"bytes1"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"jackpot","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_char","type":"bytes1"}],"name":"play","outputs":[],"payable":true,"type":"function"},{"constant":true,"inputs":[],"name":"fee","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"open","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"inputs":[{"name":"_fee","type":"uint256"},{"name":"_jackpot","type":"uint256"},{"name":"_owner_fee","type":"uint256"}],"payable":false,"type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"total","type":"uint256"}],"name":"Total","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"result","type":"bytes1"}],"name":"Result","type":"event"}];

    var address = "0x80d4644ebcd37425492ce6a2a04e8d771e6e96f4";
 
    var ETHLottery = web3.eth.contract(abi).at(address);

    var totalEvent = ETHLottery.Total(function(error, result) {
        if (!error) {
            console.log(result);
            document.getElementById('total').innerText = result.args.total / 1000000000000000000;
        }
    });

    var resultEvent = ETHLottery.Result(function(error, result) {
        if (!error) {
            document.getElementById('result').innerText = String.fromCharCode(result.args.result);
        }
    });

    var select = document.getElementById('participant');
    for (var i = 0; i < web3.eth.accounts.length; i++) {
        var opt = document.createElement('option');
        opt.innerHTML = web3.eth.accounts[i];
        opt.value = web3.eth.accounts[i];
        select.appendChild(opt);
    }

    document.getElementById('address').innerText = address;

    ETHLottery.open(function (e, c) {
        document.getElementById('open').innerText = c;
    });

    ETHLottery.total(function (e, c) {
        document.getElementById('total').innerText = c / 1000000000000000000;
    });

    ETHLottery.fee(function (e, c) {
        document.getElementById('fee').innerText = c / 1000000000000000000;
    });

    ETHLottery.owner_fee(function (e, c) {
        document.getElementById('owner-fee').innerText = c;
    });

    ETHLottery.result(function (e, c) {
        document.getElementById('result').innerText = c == "0x00" ? 'N/A' : String.fromCharCode(c);
    });
    
    function play () {
        document.getElementById('error').innerText = "";
        var participant = select.options[select.selectedIndex].value;
        var pass = document.getElementById('pass').value;
        var gas = document.getElementById('gas').value;
        var guess = document.getElementById('play').value;
        if (guess.length == 1) {
            guess = "0x" + guess.charCodeAt(0).toString(16);
            var fee = new BigNumber(document.getElementById('fee').innerText * 1000000000000000000);
            web3.personal.unlockAccount(participant, pass);
            ETHLottery.play(guess, { from : participant, value: fee, gas: gas }, function (e, c) {
                web3.personal.lockAccount(participant);
                if (e) {
                    document.getElementById('error').innerText = e.message;
                    console.log(e.message);
                }
                if (c) {
                    console.log(c);
                }
            });
        }
    }

    function withdraw () {
        document.getElementById('error').innerText = "";
        var participant = select.options[select.selectedIndex].value;
        var pass = document.getElementById('pass').value;
        var gas = document.getElementById('gas').value;
        web3.personal.unlockAccount(participant, pass);
        ETHLottery.withdraw({ from : participant, gas: gas }), function (e, c) {
            web3.personal.lockAccount(participant);
            if (e) {
                document.getElementById('error').innerText = e.message;
                console.log(e.message);
            }
            if (c) {
                console.log(c);
            }
        };
    }

</script>

</body>

</html>
